{% set duosec = salt["pillar.get"]("duosec", {}) %}

{% set vpn_internal = salt["pillar.get"]("vpn_internal_network") %}
{% set psf_internal = salt["pillar.get"]("psf_internal_network") %}
{% set pypi_internal = salt["pillar.get"]("pypi_internal_network") %}

{% set vpn_internal = salt["ip_picker.subnet_mask_for_cidr"](cidr=vpn_internal) %}
{% set psf_internal = salt["ip_picker.subnet_mask_for_cidr"](cidr=psf_internal) %}
{% set pypi_internal = salt["ip_picker.subnet_mask_for_cidr"](cidr=pypi_internal) %}

port 443
proto udp

dev tun

ca   keys/ca.crt
cert keys/server.crt
key  keys/server.key  # This file should be kept secret
dh   keys/dh.pem

crl-verify keys/crl.pem

server {{ vpn_internal.address }} {{ vpn_internal.subnet }}

ifconfig-pool-persist ipp.txt

push "route {{ psf_internal.address }} {{ psf_internal.subnet }}" # psf-internal
push "route {{ pypi_internal.address }} {{ pypi_internal.subnet }}" # pypi-internal

keepalive 10 120

tls-auth keys/ta.key 0 # This file is secret
tls-cipher TLS-DHE-RSA-WITH-AES-256-GCM-SHA384:TLS-DHE-RSA-WITH-AES-256-CBC-SHA256:TLS-DHE-RSA-WITH-AES-256-CBC-SHA

cipher AES-256-CBC

comp-lzo

user nobody
group nogroup

persist-key
persist-tun

status openvpn-status.log
verb 3

client-config-dir ccd

ccd-exclusive


reneg-sec 0

plugin /opt/duo/duo_openvpn.so {{ duosec.openvpn.ikey }} {{ duosec.openvpn.skey }} {{ duosec.openvpn.host }}
