description "pycon-progcom gunicorn application server"
start on runlevel [2345]
stop on runlevel [06]

console log
setuid pycon-progcom
setgid pycon-progcom

{% from "consul/jinja.sls" import simple_service -%}

chdir /srv/pycon-progcom/progcom
env LC_ALL=en_US.UTF-8
env LANG=en_US.UTF-8
env ADMIN_EMAILS={{ admin_emails }}
env EMAIL_FROM={{ email_from }}
env FLASK_SECRET_KEY={{ flask_secret_key }}
env ITSD_KEY={{ itsd_key }}
env OBSERVER_EMAILS={{ observer_emails }}
{% call(addr, port) simple_service("primary.postgresql") %}
env PSQL_CONNECTION_STRING=postgresql+psycopg2://{{ pg_user }}:{{ pillar["postgresql-users"][pg_user] }}@postgresql.psf.io:5432/{{ pg_db }}
{% endcall %}
env PYCON_API_HOST={{ pycon_api_host }}
env PYCON_API_KEY={{ pycon_api_key }}
env PYCON_API_SECRET={{ pycon_api_secret }}
env ROOMS={{ rooms }}
env ROOM_SCHEDULES={{ room_schedules }}
env SENDGRID_API_KEY={{ sendgrid_api_key }}
env SLACK_TOKEN={{ slack_token }}
env WEB_HOST={{ web_host }}


respawn
exec /srv/pycon-progcom/env/bin/gunicorn app:app --worker-class gevent -b 127.0.0.1:8002 --log-level=info
